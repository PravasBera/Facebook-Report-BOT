<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Facebook Automation Tool</title>
<style>
  :root{
    --accent:#2563eb;
    --muted:#6b7280;
    --card:#fff;
    --bg:#f3f6fb;
    --radius:12px;
    --shadow: 0 6px 18px rgba(16,24,40,0.08);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  html,body{height:100%; margin:0; background:linear-gradient(180deg,#e6f0ff 0%, #f7fbff 100%); color:#0f172a;}
  .wrap{max-width:920px; margin:22px auto; padding:18px;}
  .header{
    background:linear-gradient(90deg,#2563eb,#4f46e5);
    color:white;
    padding:18px; border-radius:16px; display:flex; gap:18px; align-items:center; justify-content:space-between;
    box-shadow:var(--shadow);
  }
  .title{font-weight:700; font-size:20px; letter-spacing:0.2px;}
  .meta{font-size:13px; opacity:0.95;}
  .card{background:var(--card); margin-top:18px; border-radius:var(--radius); box-shadow:var(--shadow); padding:16px;}
  .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
  .input{
    width:100%; padding:12px 14px; border-radius:10px; border:1px solid #e6e9ef; background:#fff; font-size:15px;
    box-sizing:border-box;
  }
  .small{font-size:13px; color:var(--muted);}
  .segmented{display:flex; gap:8px;}
  .segmented button{padding:10px 14px; border-radius:999px; border:1px solid transparent; background: #fff; cursor:pointer; box-shadow: 0 4px 10px rgba(12, 18, 37, 0.04);}
  .segmented button.active{background:linear-gradient(90deg,#eef2ff,#e6f0ff); border-color:#c7d2fe; color:#1e293b; font-weight:600;}
  .label{font-weight:700; margin-bottom:8px;}
  .options-list{display:flex; flex-direction:column; gap:10px; margin-top:8px;}
  .opt{display:flex; align-items:center; gap:12px; padding:12px; border-radius:10px; border:1px solid #eef2f8; background:#fff;}
  .opt input{width:18px; height:18px;}
  .actions{display:flex; gap:12px; margin-top:12px; align-items:center;}
  .btn{padding:12px 18px; border-radius:10px; cursor:pointer; border:0; font-weight:700;}
  .btn-primary{background:var(--accent); color:white;}
  .btn-ghost{background:#fff; border:1px solid #e6e9ef;}
  .upload{display:flex; gap:10px; align-items:center;}
  .logbox{margin-top:14px; border-radius:10px; background:#0f172a; color:#d1fae5; min-height:120px; padding:12px; font-family:monospace; font-size:13px; overflow:auto;}
  .status{display:flex; gap:10px; align-items:center;}
  .dot{width:12px; height:12px; border-radius:999px; background:#ef4444;}
  .dot.running{background:#10b981;}
  footer{margin-top:18px; text-align:center; color:var(--muted); font-size:13px;}
  @media (min-width:860px){
    .grid{display:grid; grid-template-columns:1fr 360px; gap:18px;}
    .card.side{position:sticky; top:22px; height: fit-content;}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <div class="title">‚ö° Facebook Automation Tool</div>
        <div class="meta">Author: <strong>PRAVAS BERA</strong> ‚Ä¢ Version: <strong>Premium</strong> ‚Ä¢ Country: <strong>INDIA</strong></div>
      </div>
      <div class="meta small">üî• INDIAN DANGER OF BULLET TEAM üî•</div>
    </div>

    <div class="grid" style="margin-top:16px;">
      <!-- LEFT / MAIN -->
      <div>
        <div class="card">
          <div style="display:flex; gap:8px; align-items:center;">
            <input id="adminToken" class="input" placeholder="Enter Admin Token here (x-admin-token)" />
            <button id="saveToken" class="btn btn-ghost">Save</button>
          </div>

          <div style="margin-top:14px;">
            <div class="label">Choose Report Type</div>
            <div class="segmented" id="typeButtons">
              <button data-type="profile" class="active">Profile</button>
              <button data-type="page">Page</button>
              <button data-type="post">Post</button>
            </div>
          </div>

          <div style="margin-top:14px;">
            <div class="label">Target URL / ID</div>
            <input id="target" class="input" placeholder="https://facebook.com/..." />
          </div>

          <div id="optionsContainer" style="margin-top:14px;">
            <div class="label" id="optionsTitle">Profile Report Options</div>
            <div class="options-list" id="optionsList">
              <!-- options inserted by JS -->
            </div>
          </div>

          <div style="margin-top:14px;">
            <div class="label">Cookies upload</div>
            <div class="upload">
              <input id="cookiesFile" type="file" accept=".txt" />
              <button id="uploadCookies" class="btn btn-ghost">Upload Cookies</button>
              <div class="small" id="cookiesStatus">Each line = 1 cookie string</div>
            </div>
          </div>

          <div style="margin-top:14px;" class="actions">
            <button id="startBtn" class="btn btn-primary">Start</button>
            <button id="stopBtn" class="btn btn-ghost">Stop</button>
            <div class="status" style="margin-left:auto;">
              <div id="serverDot" class="dot"></div>
              <div id="serverText" class="small">Idle</div>
            </div>
          </div>

          <div style="margin-top:14px;">
            <div class="label">Live Logs</div>
            <div id="logbox" class="logbox"></div>
          </div>
        </div>
      </div>

      <!-- RIGHT / SIDE -->
      <div>
        <div class="card side">
          <div style="font-weight:700; margin-bottom:8px;">Job Summary</div>
          <div class="small" id="summary">Selected: 0</div>

          <hr style="margin:12px 0;border:none;border-top:1px solid #eef2f8;" />

          <div style="font-weight:700; margin-bottom:8px;">Flow Set</div>
          <select id="flowSet" class="input" style="padding:10px;">
            <option value="">-- select flow --</option>
            <!-- you can populate these options from server if you want -->
          </select>

          <div style="margin-top:12px;">
            <div class="small">Admin token is used in header: <code>x-admin-token</code></div>
          </div>
        </div>
      </div>
    </div>

    <footer class="small">¬© 2025 Facebook Automation Tool ‚Äî Made with ‚ù§Ô∏è by INDIAN DANGER OF BULLET TEAM</footer>
  </div>

<script>
/* --- Sample options (maps to flows.js names). Replace or extend as needed --- */
const FLOW_OPTIONS = {
  profile: [
    "Problem involving someone under 18",
    "Bullying, harassment or abuse",
    "Violent, hateful or disturbing content",
    "Adult content",
    "Fake profile"
  ],
  page: [
    "Problem involving someone under 18",
    "Bullying, harassment or abuse",
    "Violent, hateful or disturbing content",
    "Adult content",
    "Fake page"
  ],
  post: [
    "Problem involving someone under 18",
    "Bullying, harassment or abuse",
    "Violent, hateful or disturbing content",
    "Adult content"
  ]
};

const typeButtons = document.getElementById('typeButtons');
const optionsList = document.getElementById('optionsList');
const optionsTitle = document.getElementById('optionsTitle');
const summary = document.getElementById('summary');
const logbox = document.getElementById('logbox');
const serverDot = document.getElementById('serverDot');
const serverText = document.getElementById('serverText');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const adminTokenInput = document.getElementById('adminToken');
const saveTokenBtn = document.getElementById('saveToken');
const cookiesFile = document.getElementById('cookiesFile');
const uploadCookiesBtn = document.getElementById('uploadCookies');
const targetInput = document.getElementById('target');
const flowSet = document.getElementById('flowSet');

let currentType = 'profile';
let cookiesContent = null;
let eventSource = null;
let selectedCount = 0;

function setActiveType(t){
  currentType = t;
  Array.from(typeButtons.querySelectorAll('button')).forEach(btn=>{
    btn.classList.toggle('active', btn.dataset.type===t);
  });
  renderOptions();
}

function renderOptions(){
  optionsList.innerHTML = '';
  const opts = FLOW_OPTIONS[currentType] || [];
  optionsTitle.textContent = (currentType.charAt(0).toUpperCase()+currentType.slice(1)) + ' Report Options';
  selectedCount = 0;
  opts.forEach((label, idx)=>{
    const id = `opt_${currentType}_${idx}`;
    const row = document.createElement('label');
    row.className = 'opt';
    row.innerHTML = `<input type="checkbox" id="${id}" value="${label}" /> <div style="flex:1">${label}</div>`;
    optionsList.appendChild(row);

    row.querySelector('input').addEventListener('change', ()=> {
      updateSummary();
    });
  });
  updateSummary();
}

function updateSummary(){
  const checked = Array.from(optionsList.querySelectorAll('input[type=checkbox]:checked')).map(i=>i.value);
  selectedCount = checked.length;
  summary.textContent = `Selected: ${selectedCount}`;
}

typeButtons.addEventListener('click', (e)=>{
  const b = e.target.closest('button[data-type]');
  if(!b) return;
  setActiveType(b.dataset.type);
});

// Save admin token to localStorage
saveTokenBtn.addEventListener('click', ()=>{
  const t = adminTokenInput.value.trim();
  localStorage.setItem('adminToken', t);
  alert('Admin token saved locally.');
});

// read saved token on load
window.addEventListener('load', ()=>{
  const t = localStorage.getItem('adminToken');
  if(t){ adminTokenInput.value = t; }
  setActiveType(currentType);

  // Try attach to events automatically
  startSSE();
});

// file upload preview
uploadCookiesBtn.addEventListener('click', async ()=>{
  const f = cookiesFile.files[0];
  if(!f){ alert('Choose a cookies.txt file first'); return; }
  const txt = await f.text();
  cookiesContent = txt.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  document.getElementById('cookiesStatus').textContent = `${cookiesContent.length} cookies loaded`;
});

// Start job
startBtn.addEventListener('click', async ()=>{
  const token = adminTokenInput.value.trim();
  if(!token){ alert('Please enter admin token'); return; }
  const target = targetInput.value.trim();
  if(!target){ alert('Enter target URL / ID'); return; }

  // collect selected options
  const options = Array.from(optionsList.querySelectorAll('input[type=checkbox]:checked')).map(i=>i.value);

  const payload = {
    type: currentType,
    target,
    options,
    cookies: cookiesContent || null
  };

  setServerState('starting');

  try{
    const res = await fetch('/report', {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'x-admin-token': token
      },
      body: JSON.stringify(payload)
    });
    const j = await res.json();
    if(!res.ok){
      alert('Server error: ' + (j?.message || res.statusText));
      setServerState('idle');
      return;
    }
    appendLog(`Job accepted: ${j.message || 'ok'}`);
    setServerState('running');
    // open SSE if not open
    if(!eventSource) startSSE();
  }catch(err){
    appendLog('Start request failed: ' + err.message);
    setServerState('idle');
  }
});

// Stop job
stopBtn.addEventListener('click', async ()=>{
  const token = adminTokenInput.value.trim();
  if(!token){ alert('Please enter admin token'); return; }
  setServerState('stopping');
  try{
    // POST /stop (server needs to implement)
    const res = await fetch('/stop', {
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'x-admin-token': token },
      body: JSON.stringify({ reason:'manual' })
    });
    const j = await res.json();
    appendLog(`Stop requested: ${j?.message || res.statusText}`);
    setServerState('idle');
  }catch(err){
    appendLog('Stop request failed: ' + err.message);
    setServerState('idle');
  }
});

/* --- SSE (live logs) --- */
function startSSE(){
  if(typeof(EventSource) === 'undefined'){ appendLog('SSE not supported in this browser'); return; }
  if(eventSource) return;
  try{
    eventSource = new EventSource('/events');
    eventSource.onopen = ()=> appendLog('[SSE] connected');
    eventSource.onerror = (e)=> {
      appendLog('[SSE] connection error or closed');
      // do not auto-reconnect forever; attempt manual reconnect after 5s
      eventSource.close();
      eventSource = null;
      setTimeout(()=> startSSE(), 5000);
    };
    eventSource.addEventListener('log', (ev)=>{
      appendLog(ev.data);
    });
    eventSource.addEventListener('status', (ev)=>{
      const data = ev.data;
      if(data === 'running') setServerState('running');
      else if(data === 'idle') setServerState('idle');
      appendLog('[status] ' + data);
    });
  }catch(err){
    appendLog('SSE failed: ' + err.message);
  }
}

function appendLog(text){
  const line = document.createElement('div');
  line.textContent = new Date().toLocaleTimeString() + '  ' + text;
  logbox.appendChild(line);
  logbox.scrollTop = logbox.scrollHeight;
}

/* server state UI */
function setServerState(s){
  if(s === 'running'){
    serverDot.classList.add('running');
    serverText.textContent = 'Running';
  } else if(s === 'starting'){
    serverDot.classList.remove('running');
    serverText.textContent = 'Starting‚Ä¶';
  } else if(s === 'stopping'){
    serverDot.classList.remove('running');
    serverText.textContent = 'Stopping‚Ä¶';
  } else {
    serverDot.classList.remove('running');
    serverText.textContent = 'Idle';
  }
}

/* optional: allow flowSet being filled (if server provides /flows endpoint)
fetch('/flows').then(r=>r.json()).then(list=>{
  list.forEach(f=>{
    const opt = document.createElement('option');
    opt.value = f.name; opt.textContent = f.title || f.name;
    flowSet.appendChild(opt);
  });
}).catch(()=>{/* ignore */});

/* helper: quick keyboard shortcuts */
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter' && (e.ctrlKey || e.metaKey)){
    startBtn.click();
  }
});
</script>
</body>
</html>
