<!-- public/index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FB Auto Reporter ‚Äî Stylish UI</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google font -->
  <link href="https://fonts.googleapis.com/css2?family=Anton&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --accent:#0ea5e9;  /* cyan-500 */
      --pink:#fda4af;    /* rose-200 */
      --glass: rgba(255,255,255,0.85);
    }
    body{ font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, Arial; background: linear-gradient(180deg,#f8fafc 0%, #eef2ff 100%); }
    .banner { background: linear-gradient(90deg,#0f172a,#1e40af); color: #fff; }
    .bigbox { border: 6px solid #0f172a; box-shadow: 10px 10px 0 rgba(0,0,0,0.12); }
    .huge { font-family: "Anton", sans-serif; letter-spacing: -1px; }
    .btn-ghost { background: transparent; border: 2px solid rgba(0,0,0,0.06); }
    .checkbox-card { transition: transform .12s ease, box-shadow .12s ease; }
    .checkbox-card:hover { transform: translateY(-4px); box-shadow: 0 12px 30px rgba(2,6,23,0.08); }
    /* modal backdrop */
    .modal-backdrop { backdrop-filter: blur(4px); background: rgba(2,6,23,0.45); }
    /* logs mono */
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, monospace; }
  </style>
</head>
<body class="min-h-screen text-slate-800">

  <!-- Header -->
  <header class="banner py-6">
    <div class="max-w-4xl mx-auto text-center px-4">
      <h1 class="text-4xl md:text-5xl font-extrabold">‚ö° Facebook Automation Tool ‚ö°</h1>
      <p class="mt-2 text-sm md:text-base opacity-90">Author: <strong>PRAVAS BERA</strong>  ¬∑  <strong>Premium</strong>  ¬∑  Country: <strong>INDIA</strong></p>
      <p class="mt-3 text-yellow-300 font-semibold">üî• INDIAN DANGER OF BULLET TEAM üî•</p>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-4xl mx-auto p-6 -mt-8 relative z-10">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

      <!-- Left column: controls -->
      <section class="col-span-2 bg-white rounded-xl p-6 shadow-lg bigbox">
        <!-- Admin token -->
        <div class="mb-6 text-center">
          <label class="block text-lg font-semibold mb-2">Enter Admin Token</label>
          <input id="adminToken" placeholder="x-admin-token" class="w-full p-4 text-xl rounded-lg border-2 border-slate-200 text-center" />
        </div>

        <!-- report type -->
        <div class="mb-6 text-center">
          <h2 class="huge text-3xl md:text-4xl">Choose Report Type</h2>
          <div class="mt-4 flex justify-center gap-4">
            <button data-type="profile" class="type-btn px-6 py-3 rounded-lg text-lg font-semibold btn-ghost">‚òê Profile</button>
            <button data-type="page" class="type-btn px-6 py-3 rounded-lg text-lg font-semibold btn-ghost">‚òê Page</button>
            <button data-type="post" class="type-btn px-6 py-3 rounded-lg text-lg font-semibold btn-ghost">‚òê Post</button>
          </div>
        </div>

        <!-- target url -->
        <div class="mb-6">
          <label class="block text-lg font-semibold mb-2">Target URL / ID</label>
          <input id="targetUrl" placeholder="https://www.facebook.com/..." class="w-full p-4 text-xl rounded-md border border-slate-200 bigbox" />
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
          <!-- file -->
          <div>
            <label class="block text-sm font-medium mb-2">Upload Cookies (cookies.txt)</label>
            <div class="flex items-center gap-3">
              <input id="cookieFile" type="file" accept=".txt" class="hidden" />
              <button onclick="document.getElementById('cookieFile').click()" class="px-4 py-3 bg-slate-800 text-white rounded-lg shadow">Choose File</button>
              <div id="cookieName" class="text-sm text-slate-500">No file selected</div>
            </div>
            <p class="text-xs text-slate-400 mt-2">Each line = one account cookie string (fr=...; xs=...; c_user=...)</p>
          </div>

          <!-- options -->
          <div>
            <label class="block text-sm font-medium mb-2 invisible">placeholder</label>
            <button id="chooseOptionsBtn" class="w-full p-3 bg-pink-200 hover:bg-pink-300 rounded-lg huge text-lg shadow">Choose Report Options</button>
          </div>
        </div>

        <!-- flow + actions -->
        <div class="mt-6 flex flex-col md:flex-row gap-3 items-center">
          <div class="flex-1">
            <label class="block text-sm font-medium mb-2">Flow Set</label>
            <select id="flowSet" class="w-full p-3 rounded border border-slate-200">
              <option value="">-- select flow set --</option>
            </select>
          </div>

          <div class="flex gap-2">
            <button id="uploadCookiesBtn" class="px-4 py-3 bg-slate-700 text-white rounded shadow">üìÇ Upload</button>
            <button id="startBtn" class="px-4 py-3 bg-gradient-to-br from-sky-500 to-blue-600 text-white rounded shadow">‚ñ∂ Start</button>
            <button id="stopBtn" class="px-4 py-3 bg-rose-600 text-white rounded shadow">‚èπ Stop</button>
          </div>
        </div>

        <!-- small help -->
        <p class="mt-4 text-xs text-slate-400">Tip: upload a cookies.txt file or multiple .txt account files in the uploads folder. Use a valid admin token header (x-admin-token).</p>
      </section>

      <!-- Right column: logs + quick -->
      <aside class="bg-white rounded-xl p-4 shadow-lg flex flex-col gap-4">
        <div>
          <h3 class="text-lg font-bold">Quick Controls</h3>
          <div class="mt-3 grid grid-cols-1 gap-2">
            <button id="exampleCookies" class="w-full px-3 py-2 border rounded text-sm">Download example cookies.txt</button>
            <button id="clearLogsBtn" class="w-full px-3 py-2 border rounded text-sm">Clear Logs</button>
          </div>
        </div>

        <div>
          <h3 class="text-lg font-bold">üìú Live Logs</h3>
          <div id="logs" class="h-72 overflow-auto rounded p-3 bg-slate-900 text-emerald-300 mono text-sm"></div>
        </div>
      </aside>
    </div>
  </main>

  <!-- Modal (report options) -->
  <div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
    <div class="modal-backdrop absolute inset-0"></div>
    <div class="relative bg-white w-11/12 md:w-3/4 max-w-3xl rounded-xl p-6 z-10 shadow-2xl">
      <div class="flex justify-between items-center mb-4">
        <h4 class="text-2xl font-bold">Choose Report Options</h4>
        <button id="modalClose" class="text-slate-600">‚úï</button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <h5 class="font-semibold mb-2">Profile</h5>
          <div id="profileOptions" class="space-y-2"></div>
        </div>

        <div>
          <h5 class="font-semibold mb-2">Page</h5>
          <div id="pageOptions" class="space-y-2"></div>
        </div>

        <div>
          <h5 class="font-semibold mb-2">Post</h5>
          <div id="postOptions" class="space-y-2"></div>
        </div>
      </div>

      <div class="mt-6 flex justify-end gap-3">
        <button id="modalClear" class="px-4 py-2 border rounded">Clear</button>
        <button id="modalSave" class="px-4 py-2 bg-emerald-600 text-white rounded">Save selections</button>
      </div>
    </div>
  </div>

<script>
/* ========================================
   UI behavior + server wiring (flows, SSE)
   ======================================== */

let flows = { profileSets:[], pageSets:[], postSets:[] };

const logEl = document.getElementById('logs');
function log(msg){
  const time = new Date().toLocaleTimeString();
  logEl.innerHTML += `<div class="mb-1"><span class="text-slate-400 mr-2">[${time}]</span>${escapeHtml(msg)}</div>`;
  logEl.scrollTop = logEl.scrollHeight;
}
function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* load flows from server and populate dropdown */
async function loadFlows(){
  try {
    const r = await fetch('/flows');
    if (!r.ok) throw new Error('no flows');
    flows = await r.json();
    log('Flows loaded from server');
  } catch (e){
    log('Flows not available on server ‚Äî using fallback');
    flows = {
      profileSets:[ {id:'ProfileSet1', name:'Profile Set 1'}, {id:'ProfileSet2', name:'Profile Set 2'} ],
      pageSets:[ {id:'PageSet1', name:'Page Set 1'} ],
      postSets:[ {id:'PostSet1', name:'Post Set 1'} ]
    };
  }
  populateFlowDropdown();
}

function populateFlowDropdown(){
  const sel = document.getElementById('flowSet');
  sel.innerHTML = '<option value="">-- select flow set --</option>';
  const type = document.querySelector('.type-btn.bg-emerald-100')?.dataset?.type || 'page';
  const map = { profile: 'profileSets', page:'pageSets', post:'postSets' };
  const list = flows[map[type]] || [];
  for (const s of list) {
    const o = document.createElement('option');
    o.value = s.id;
    o.textContent = s.name || s.id;
    sel.appendChild(o);
  }
}

/* preset option lists (match your flows.js categories) */
const PROFILE_OPTS = [
  "Problem involving someone under 18",
  "Bullying, harassment or abuse",
  "Violent, hateful or disturbing content",
  "Adult content",
  "Fake profile"
];
const PAGE_OPTS = [
  "Problem involving someone under 18",
  "Bullying, harassment or abuse",
  "Violent, hateful or disturbing content",
  "Adult content",
  "Fake page"
];
const POST_OPTS = [
  "Problem involving someone under 18",
  "Bullying, harassment or abuse",
  "Violent, hateful or disturbing content",
  "Adult content"
];

/* render modal options */
function makeOptionCheckbox(id, label){
  const wrap = document.createElement('label');
  wrap.className = 'flex items-center gap-3 p-3 border rounded-lg checkbox-card cursor-pointer';
  wrap.innerHTML = `<input id="${id}" type="checkbox" class="h-5 w-5"><div class="text-sm font-medium">${label}</div>`;
  return wrap;
}
function renderOptions(){
  const p = document.getElementById('profileOptions');
  const pg = document.getElementById('pageOptions');
  const po = document.getElementById('postOptions');
  p.innerHTML = ''; pg.innerHTML = ''; po.innerHTML = '';
  PROFILE_OPTS.forEach((t,i)=> p.appendChild(makeOptionCheckbox('profile_opt_'+i, t)));
  PAGE_OPTS.forEach((t,i)=> pg.appendChild(makeOptionCheckbox('page_opt_'+i, t)));
  POST_OPTS.forEach((t,i)=> po.appendChild(makeOptionCheckbox('post_opt_'+i, t)));
}

/* modal controls */
const modal = document.getElementById('modal');
document.getElementById('chooseOptionsBtn').addEventListener('click', ()=>{
  renderOptions();
  // restore previous selections if any
  const prev = JSON.parse(localStorage.getItem('selectedReportOptions') || '[]');
  modal.querySelectorAll('input[type=checkbox]').forEach(cb=>{
    const label = cb.parentElement.querySelector('div').textContent.trim();
    cb.checked = prev.includes(label);
  });
  modal.classList.remove('hidden');
});
document.getElementById('modalClose').addEventListener('click', ()=> modal.classList.add('hidden'));
document.getElementById('modalClear').addEventListener('click', ()=>{
  modal.querySelectorAll('input[type=checkbox]').forEach(cb=> cb.checked = false);
});
document.getElementById('modalSave').addEventListener('click', ()=>{
  const selected = Array.from(modal.querySelectorAll('input[type=checkbox]:checked')).map(cb=> cb.parentElement.querySelector('div').textContent.trim());
  localStorage.setItem('selectedReportOptions', JSON.stringify(selected));
  log('Selected options saved: ' + (selected.join(', ') || 'none'));
  modal.classList.add('hidden');
});

/* file input display */
document.getElementById('cookieFile').addEventListener('change', (e)=>{
  const f = e.target.files[0];
  document.getElementById('cookieName').textContent = f ? f.name : 'No file selected';
});

/* type buttons */
document.querySelectorAll('.type-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.type-btn').forEach(b=> b.classList.remove('bg-emerald-100'));
    btn.classList.add('bg-emerald-100');
    populateFlowDropdown();
  });
});

/* example cookies */
document.getElementById('exampleCookies').addEventListener('click', async ()=>{
  try {
    const r = await fetch('/exampleCookies');
    const t = await r.text();
    const blob = new Blob([t], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'cookies.example.txt'; a.click();
    URL.revokeObjectURL(url);
  } catch (e) { log('exampleCookies failed: ' + e.message); }
});

/* upload cookies to server */
document.getElementById('uploadCookiesBtn').addEventListener('click', async ()=>{
  const token = document.getElementById('adminToken').value.trim();
  if (!token) return alert('Admin token required');
  const f = document.getElementById('cookieFile').files[0];
  if (!f) return alert('Select cookies.txt first');
  const fd = new FormData(); fd.append('cookies', f);
  log('Uploading cookies...');
  try {
    const res = await fetch('/uploadCookies', { method:'POST', headers: { 'x-admin-token': token }, body: fd });
    const j = await res.json();
    if (j.ok) log('‚úÖ Cookies uploaded'); else log('‚ùå Upload failed: ' + (j.message || j.error || JSON.stringify(j)));
  } catch (e) { log('Upload error: ' + e.message); }
});

/* start / stop job */
let sse = null;
document.getElementById('startBtn').addEventListener('click', async ()=>{
  const token = document.getElementById('adminToken').value.trim();
  const targetUrl = document.getElementById('targetUrl').value.trim();
  const setId = document.getElementById('flowSet').value;
  const setType = document.querySelector('.type-btn.bg-emerald-100')?.dataset?.type;
  if (!token) return alert('Admin token required');
  if (!setType) return alert('Pick type (profile/page/post)');
  if (!targetUrl) return alert('targetUrl required');
  if (!setId) return alert('Pick flow set');
  const body = { sessionId:'ui', targetUrl, setType, setId };
  log('Starting job...');
  try {
    const res = await fetch('/start', { method:'POST', headers:{ 'Content-Type':'application/json', 'x-admin-token': token }, body: JSON.stringify(body) });
    const j = await res.json();
    if (j.ok) { log('üöÄ Job started'); startSSE(); } else log('‚ùå Start failed: ' + (j.message || j.error || JSON.stringify(j)));
  } catch (e){ log('Start error: ' + e.message); }
});
document.getElementById('stopBtn').addEventListener('click', async ()=>{
  const token = document.getElementById('adminToken').value.trim();
  if (!token) return alert('Admin token required');
  try {
    const res = await fetch('/stop', { method:'POST', headers:{ 'Content-Type':'application/json', 'x-admin-token': token }, body: JSON.stringify({ sessionId:'ui' }) });
    const j = await res.json();
    if (j.ok) log('‚èπ Stop requested'); else log('Stop failed: ' + (j.message || j.error));
  } catch (e){ log('Stop error: ' + e.message); }
});

/* SSE start */
function startSSE(){
  if (sse) try { sse.close(); } catch {}
  sse = new EventSource('/events?sessionId=ui');
  sse.onopen = ()=> log('SSE connected');
  sse.onmessage = e => { try { const p = JSON.parse(e.data); log('MSG: ' + (p.msg || JSON.stringify(p))); } catch { log('RAW: ' + e.data); } };
  ['log','info','warn','error','success','done','fatal'].forEach(ev=>{
    sse.addEventListener(ev, e => {
      try { const p = JSON.parse(e.data); log('['+ev+'] ' + (p.msg || JSON.stringify(p))); } catch { log('['+ev+'] ' + e.data); }
    });
  });
}

/* clear logs */
document.getElementById('clearLogsBtn').addEventListener('click', ()=> { logEl.innerHTML = ''; });

/* initialize */
(async ()=>{
  // default select page
  document.querySelectorAll('.type-btn').forEach(b=> b.classList.remove('bg-emerald-100'));
  document.querySelector('.type-btn[data-type="page"]').classList.add('bg-emerald-100');
  await loadFlows();
  log('UI ready ‚Äî styled version loaded');
})();

</script>
</body>
</html>
